<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />

        <title>Типизируй это немедленно!</title>

        <meta
            name="description"
            content="Groovy — язык, который идеально подходит для реализации DSL. Но чем сложнее DSL, тем тяжелее найти в нем ошибку. Вместе с командой мы решили эту проблему, типизировав свой DSL."
        />
        <meta name="author" content="NAUMEN, Павел Зыков" />

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />

        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"
        />

        <link rel="stylesheet" href="css/reveal.css" />
        <link rel="stylesheet" href="css/fedya.css" />
        <link rel="stylesheet" href="css/computer.css" />
        <link rel="stylesheet" href="css/theme/white.css" id="theme" />

        <link rel="stylesheet" href="css/hljs/vs.css" id="highlight-theme" />

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement("link");
            link.rel = "stylesheet";
            link.type = "text/css";
            link.href = window.location.search.match(/print-pdf/gi)
                ? "css/print/pdf.css"
                : "css/print/paper.css";
            document.getElementsByTagName("head")[0].appendChild(link);
        </script>

        <!--[if lt IE 9]>
            <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

        <style>
            .reveal .slide-number {
                font-size: 22pt;
                color: black;
            }

            .reveal pre {
                background: none;
                border: none;
                box-shadow: none;
            }

            .reveal pre code {
                color: black;
                background: none;
                box-shadow: none;
                max-height: none;
                overflow: hidden;
            }

            .reveal pre code.mini {
                font-size: 6pt;
                line-height: normal;
            }

            .reveal pre code.small {
                font-size: 8pt;
                line-height: normal;
            }

            .reveal pre code.medium {
                font-size: 10pt;
                line-height: normal;
            }

            .reveal section img {
                border: none;
                box-shadow: none;
                max-width: 70%;
            }

            .reveal .footer {
                font-size: 22pt;
                color: black;
                text-align: center;
                position: absolute;
                width: 100%;
                bottom: 0.5em;
            }

            .reveal .cartoon {
                position: absolute;
                right: 0;
                bottom: 0;
            }

            .reveal .rubber_stamp {
                font-family: "Vollkorn", serif;
                font-size: 39px;
                line-height: 45px;
                text-transform: uppercase;
                font-weight: bold;
                color: red;
                border: 7px solid red;
                float: left;
                padding: 10px 7px;
                border-radius: 10px;

                opacity: 0.8;
                -webkit-transform: rotate(-10deg);
                -o-transform: rotate(-10deg);
                -moz-transform: rotate(-10deg);
                -ms-transform: rotate(-10deg);
                position: absolute;
                bottom: 20%;
                right: 1%;
            }

            .reveal .rubber_stamp::after {
                position: absolute;
                content: " ";
                width: 100%;
                height: auto;
                min-height: 100%;
                top: -10px;
                left: -10px;
                padding: 10px;
                background: url(img/noise.png) repeat;
            }

            .reveal .nau {
                color: orangered;
                font-weight: bold;
                font-family: "Franklin Gothic Medium", "Arial Narrow", Arial,
                    sans-serif;
            }
            section.pain {
                background-image: url(img/crying_twins.jpg);
                background-size: cover;
                width: 100%;
                height: 100%;
            }
            .dialog {
                display: flex;
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
            }
            div.baloon {
                background-color: #fff;
                border-radius: 20px;
                padding: 10px;
                max-height: 70px;
                line-height: 70px;
                text-align: right;
            }
            div.baloon.incoming:after {
                content: '';
                position: relative;
                top:90px;
                width: 0;
                height: 0;
                border-left: 40px solid transparent;
                border-right: 0px solid transparent;
                border-top: 30px solid #FFF;
            }
            div.baloon.outgoing:before {
                content: '';
                position: relative;
                top:90px;
                width: 0;
                height: 0;
                border-left: 0px solid transparent;
                border-right: 40px solid transparent;
                border-top: 30px solid #FFF;
            }
            li.good{
                color:green;
            }
            li.bad{
                color: red;
            }
            .pyramid {
                display: flex;
                flex-direction: column-reverse;
                justify-content: center;
                align-items: center;
                color: #fff;
            }
            .pyramid > div {
                border-left: 150px solid transparent;
                border-right: 150px solid transparent;
                height: 0;
                line-height: 125px;
                text-align: center;
            }
            #portal {
                border-bottom: 125px solid #00529f;
                width: 0;
            }
            #portal:before {
                content: "Portal";
                margin-left: -50px;
            }
            #meta {
                border-bottom: 125px solid #6b89a0;
                width: 300px;
            }
            #smp {
                border-bottom: 125px solid #085896;
                width: 600px;
            }
            .credits-wrapper{
                overflow: hidden;
                width: 100%;
                height: 500px;
            }
            pre.credits{
                top: 100%;
                animation: 20s credits linear infinite;
            }
            @keyframes credits {
                0% {
                    top: 100%;
                }
                100% {
                    top: -500%;
                }
            }

            div.settings {
                position: relative;
                top: 25px;
                font-size: 70px;
            }
        </style>
    </head>

    <body>
        <div class="reveal">
            <div class="footer">
                <span class="nau">NAUMEN</span> Павел Зыков
            </div>
            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <section>
                    <h1>Типизируй это немедленно!</h1>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Введение</h2>
                    <div class="office fragment">
                        <div class="window"></div>
                        <div class="computer">
                            <div class="screen">
                                <div class="front square"></div>
                                <div class="back square"></div>
                                <div class="top square"></div>
                                <div class="left square">
                                    <div class="progressbar"></div>
                                </div>
                                <div class="left square task fragment">
                                    <article>
                                        <h1>Очень важная задача</h1>
                                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                                        <div class="bug fragment"></div>
                                    </article>
                                </div>
                                <div class="left square fragment">
                                    <pre><code data-trim class="bash mini" style="color: #4EC456;">
git checkout develop
git checkout -b newTask
                                    </code></pre>
                                </div>
                                <div class="left square fragment">
                                    <div class="progressbar"></div>
                                </div>
                                <div class="left square fragment">
                                    <div class="settings">🛠</div>
                                </div>
                                <div class="left square task fragment">
                                    <pre><code data-trim class="java mini">
class Foo
{
    public void bar()
    {
        //do something
    }
}
                                    </code></pre>
                                </div>

                                <div class="left1 square"></div>
                                <div class="back1 square"></div>
                                <div class="bottom1 square"></div>
                            </div>
                            <div class="screenbottom">
                                <div class="front2 square"></div>
                                <div class="top2 square"></div>
                                <div class="left2 square"></div>
                            </div>

                            <div class="keyboard">
                                <div class="front4 square"></div>
                                <div class="top4 square"></div>
                                <div class="left4 square"></div>
                                <div class="bottom4 square"></div>
                            </div>
                            <div class="keyboardkeys">
                                <div class="front5 square"></div>
                                <div class="top5 square"></div>
                                <div class="left5 square"></div>
                                <div class="bottom5 square"></div>
                            </div>
                            <div class="numpad">
                                <div class="front6 square"></div>
                                <div class="top6 square"></div>
                                <div class="left6 square"></div>
                                <div class="bottom6 square"></div>
                            </div>
                            <div class="trackpad"></div>
                        </div>
                    </div>
                    <div class="man-wrapper">
                        <div class="body"></div>
                        <div class="head">
                            <div class="ear" id="left"></div>
                            <div class="ear" id="right"></div>
                            <div class="hair-main">
                                <div class="sideburn" id="left"></div>
                                <div class="sideburn" id="right"></div>
                                <div class="hair-top"></div>
                            </div>
                            <div class="face">
                                <div class="nose"></div>
                                <div class="eye-shadow" id="left">
                                    <div class="eyebrow"></div>
                                    <div class="eye"></div>
                                </div>
                                <div class="eye-shadow" id="right">
                                    <div class="eyebrow"></div>
                                    <div class="eye"></div>
                                </div>
                                <div class="mouth"></div>
                                <div class="chin"></div>
                            </div>
                        </div>
                        <span class="music-note" id="one">Java</span>
                        <span class="music-note" id="two">Rocks!</span>
                    </div>

                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Ликбез</h2>
                    <h3>SMP&Portal</h3>
                    <div class="pyramid">
                        <div class="fragment" id="smp">SMP</div>
                        <div class="fragment" id="meta">Metainformation</div>
                        <div class="fragment" id="portal"></div>
                    </div>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Portal</h2>
                    <ul>
                        <li>ES6+Flow+React+Redux</li>
                        <li>Groovy</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Groovy</h2>
                    <ul>
                        <li>SMP</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Groovy</h2>
                    <ul>
                        <li>Статическая и динамическая типизация</li>
                        <li>Литералы списков, ассоциативных массивов, массивов и регулярных выражений</li>
                        <li>Перегрузка операций</li>
                        <li>AST-трансформации</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Какая задача стояла?</h2>
                    <ul>
                        <li>Услуги</li>
                        <li>Компоненты услуги</li>
                        <li>Виды запросов</li>
                        <li>Новости</li>
                        <li>Опросы</li>
                        <li>...</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Как её можно решить без DSL?</h2>
                    <ul>
                        <li>Копии БД</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section class="pain">
                    <div class="dialog">
                        <div class="baloon incoming">Я изменил дамп</div>
                        <div class="baloon outgoing">Я тоже</div>
                    </div>
                </section>
                <section>
                    <h2>Как её можно решить без DSL?</h2>
                    <ul>
                        <li>Скрипт</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Как её можно решить без DSL?</h2>
                    <h3>Скрипт</h3>
                    <pre style="width:auto;"><code data-trim class="groovy">
def login = 'fedya'
def ou = utils.create(OU_FQN, [title: 'Cупер отдел'])
def employee = utils.create(
        EMPLOYEE_FQN, [firstName: 'Федя',
                       lastName : 'Федечкин',
                       login    : login,
                       parent   : ou]
)
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Как её можно решить без DSL?</h2>
                    <h3>Скрипт</h3>
                    <pre style="width:auto;"><code data-trim class="groovy">
def category = utils.create(CATEGORY_FQN, [title: "${ login }_category${ new Date() }"])
def service = utils.create(
        SERVICE_FQN, [devsManagers  : [employee],
                      managersItServ: [employee],
                      resipPolice   : 'allEmpl',
                      servCategories: category,
                      state         : 'available',
                      title         : "${ login }_serv${ new Date() }"]
)
def component = utils.create(
        COMPONENT_FQN, [parent     : service,
                        state      : 'available',
                        title      : "${ login }_comp",
                        resipPolice: 'allEmpl']
)
def route = utils.create(
        ROUTE_FQN, [scType  : 'serviceCall$incident',
                    services: component,
                    title   : "${ login }_inc"]
)
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Как её можно решить без DSL?</h2>
                    <h3>Скрипт</h3>
                    <pre style="width:auto;"><code data-trim class="groovy medium">
def catalog = utils.create(
        USER_CATALOG_FQN, [
        title        : "${ login }_catalog",
        linkedService: service
]
)

def items = 3.times {
    utils.create(
            CATALOG_ITEM_FQN, [parent: catalog,
                               title : "${ login }_$it"]
    )
}

def attrGroup1 = utils.create(
        ATTR_GROUP_FQN, [displayName      : true,
                         ('formInService'): service,
                         sequence         : 0,
                         state            : 'active',
                         title            : "${ login }_group_for_serv"]
)
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Как её можно решить без DSL?</h2>
                    <h3>Скрипт</h3>
                    <pre style="width:auto;"><code data-trim class="groovy small">
def i = 0
def types = [] + api.metainfo.getTypes('attrs')
types[ATTRS_MULTI_BO].collect { type ->
    def typeStr = type.toString()

    def visors = visorMap[typeStr]
    if (visors)
    {
        visors.each {
            def visor = utils.findFirst('visor', [code: it])
            if (visor)
            {
                def props = [attrGroups: attrGroup1,
                             sequence  : i++,
                             title     : "${ i }_${ login }_${ visor.title }",
                             visor     : visor]
                if (type.fqnCase in USER_CATALOG_CASES)
                {
                    props.userCatalog = catalog
                }
                log(level: 'error', "create $typeStr with visor $it")
                utils.create(typeStr, props)
            }
        }
    }
    else
    {
        def props = [title: "${ i }_${ login }_${ type.title }", attrGroups: attrGroup1, sequence:
                i++]
        if (type.fqnCase in USER_CATALOG_CASES)
        {
            props.userCatalog = catalog
        }
        log("create $typeStr without visor")
        utils.create(typeStr, props)
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Как её можно решить без DSL?</h2>
                    <h3>Скрипт</h3>
                    <div class="credits-wrapper">
                        <pre class="credits" style="width:auto;"><code data-trim class="groovy">
def login = 'fedya'
def ou = utils.create(OU_FQN, [title: 'Cупер отдел'])
def employee = utils.create(
        EMPLOYEE_FQN, [firstName: 'Федя',
                       lastName : 'Федечкин',
                       login    : login,
                       parent   : ou]
)

def category = utils.create(CATEGORY_FQN, [title: "${ login }_category${ new Date() }"])
def service = utils.create(
        SERVICE_FQN, [devsManagers  : [employee],
                      managersItServ: [employee],
                      resipPolice   : 'allEmpl',
                      servCategories: category,
                      state         : 'available',
                      title         : "${ login }_serv${ new Date() }"]
)
def component = utils.create(
        COMPONENT_FQN, [parent     : service,
                        state      : 'available',
                        title      : "${ login }_comp",
                        resipPolice: 'allEmpl']
)
def route = utils.create(
        ROUTE_FQN, [scType  : 'serviceCall$incident',
                    services: component,
                    title   : "${ login }_inc"]
)
def catalog = utils.create(
        USER_CATALOG_FQN, [
        title        : "${ login }_catalog",
        linkedService: service
]
)

def items = 3.times {
    utils.create(
            CATALOG_ITEM_FQN, [parent: catalog,
                               title : "${ login }_$it"]
    )
}

def attrGroup1 = utils.create(
        ATTR_GROUP_FQN, [displayName      : true,
                         ('formInService'): service,
                         sequence         : 0,
                         state            : 'active',
                         title            : "${ login }_group_for_serv"]
)
def i = 0
def types = [] + api.metainfo.getTypes('attrs')
types[ATTRS_MULTI_BO].collect { type ->
    def typeStr = type.toString()

    def visors = visorMap[typeStr]
    if (visors)
    {
        visors.each {
            def visor = utils.findFirst('visor', [code: it])
            if (visor)
            {
                def props = [attrGroups: attrGroup1,
                             sequence  : i++,
                             title     : "${ i }_${ login }_${ visor.title }",
                             visor     : visor]
                if (type.fqnCase in USER_CATALOG_CASES)
                {
                    props.userCatalog = catalog
                }
                log(level: 'error', "create $typeStr with visor $it")
                utils.create(typeStr, props)
            }
        }
    }
    else
    {
        def props = [title: "${ i }_${ login }_${ type.title }", attrGroups: attrGroup1, sequence:
                i++]
        if (type.fqnCase in USER_CATALOG_CASES)
        {
            props.userCatalog = catalog
        }
        log("create $typeStr without visor")
        utils.create(typeStr, props)
    }
}
                        </code></pre>
                    </div>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Helicopter view</h2>
                    <img src="img/helicopter_view.svg" alt="Helicopter view">
                    <aside class="notes"></aside>
                </section>
<section>
                    <h2>Как её решает DSL?</h2>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Требования к скрипту наполнения</h2>
                    <ul>
                        <li>Создать новые объекты - легко</li>
                        <li>Добавить новые сущности - легко</li>
                        <li>Мало кода</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Рассматриваемые варианты реализации</h2>
                    <ul>
                        <li>ObjectGraphBuilder</li>
                        <li>Реализация BuilderSupport</li>
                        <li>Базовые возможности Groovy</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Пример</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
class Bo
{
    String title
}

class Company extends Bo
{
    Collection&lt;Department&gt; departments = []
}

class Department extends Bo
{
    Collection&lt;Employee&gt; employees = []
}

class Employee extends Bo
{
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>ObjectGraphBuilder</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
def builder = new ObjectGraphBuilder()
builder.classLoader = getClass().classLoader

Company  company = builder.company(title:'Рога и копыта'){
    department(title: 'Управление'){
        employee(title:'Остап Бендер')
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Требования к скрипту наполнения</h2>
                    <ul>
                        <li>Создать новые объекты - легко</li>
                        <li>Добавить новые сущности - легко</li>
                        <li>Мало кода</li>
                        <li>Малая цена ошибки</li>
                        <li>Автокомплит в IDE</li>
                        <li>Ошибки в скрипте сразу видны в IDE</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>ObjectGraphBuilder</h2>
                    <ul>
                        <li class="good">Мало кода</li>
                        <li class="bad">IDE не подсказывает</li>
                        <li class="bad">Цена ошибки высока (в Runtime)</li>
                        <li class="bad">Свои правила именования</li>
                        <li class="bad">Кастомизировать сложно</li>
                    </ul>
                    <div class="cartoon fragment"><img src="img/boo.png"/></div>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Реализация BuilderSupport</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
protected Object createNode(Object name, Map attributes) {
        switch (name) {
            case "company":
                /*do something*/
                break
            case "department":
                /*do something*/
                break
            case "employee":
                /*do something*/
                break
            default:
                throw new Exception("Unknown node ${name}")
        }
    }
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Реализация BuilderSupport</h2>
                    <ul>
                        <li class="bad">Да ну нафиг</li>
                        <li class="bad">Да ну нафиг</li>
                        <li class="bad">Да ну нафиг</li>
                    </ul>
                    <div class="cartoon"><img src="img/boo.png"/></div>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Базовые возможности Groovy</h2>
                    <p></p>
                    <pre style="width:auto;"><code data-trim class="groovy">
class Bo
{
    String title

    Bo title(String title)
    {
        this.title = title
        return this
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Базовые возможности Groovy</h2>
                    <p></p>
                    <pre style="width:auto;"><code data-trim class="groovy">
class Company extends Bo
{
    Collection&lt;Department&gt; departments = []

    static Company build(Closure config)
    {
        def company = new Company()
        company.with(config)
        return company
    }

    Company department(Closure config)
    {
        def department = new Department()
        department.with(config)
        departments &lt;&lt; department
        return this
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Базовые возможности Groovy</h2>
                    <p></p>
                    <pre style="width:auto;"><code data-trim class="groovy">
class Department extends Bo
{
    Collection&lt;Employee&gt; employees = []
    Department employee(Closure config)
    {
        def employee = new Employee()
        employee.with(config)
        employees &lt;&lt; employee
        return this
    }
}

class Employee extends Bo
{
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Базовые возможности Groovy</h2>
                    <p></p>
                    <pre style="width:auto;"><code data-trim class="groovy">
Company.build {
    title 'Рога и копыта'
    department {
        title 'Управление'
        employee {
            title 'Остап Бендер'
        }
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Базовые возможности Groovy</h2>
                    <ul>
                        <li class="good">IDE подсказывает</li>
                        <li class="good">Именуем как удобно</li>
                        <li class="good">Кастомизировать легко</li>
                        <li class="bad">IDE не подсказывает</li>
                        <li class="bad">Цена ошибки высока (в Runtime)</li>
                        <li class="bad">Много кода</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>duck typing vs @TypeChecked vs @CompileStatic</h2>
                    <ul>
                        <li>duck typing == забыть про автокомплит</li>
                        <li>@TypeChecked - проверяет типы при компиляции и только.</li>
                        <li>@CompileStatic - проверяет типы и старается генерировать  байт код близкий к javac</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Особенности типизации DSL. Аннотация @DelegatesTo</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
class Department extends Bo
{
    Collection&lt;Employee&gt; employees = []
    Department employee(@DelegatesTo(Employee) Closure config)
    {
        def employee = new Employee()
        employee.with(config)
        employees &lt;&lt; employee
        return this
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Базовые возможности Groovy</h2>
                    <ul>
                        <li class="good">IDE подсказывает</li>
                        <li class="good">Именуем как удобно</li>
                        <li class="good">Кастомизировать легко</li>
                        <li class="good">Автодополнение в IDE</li>
                        <li class="good">Ошибки видно при компиляции</li>
                        <li class="bad">Много кода</li>
                    </ul>
                    <div class="rubber_stamp fragment">APPROVED</div>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Базовые возможности Groovy, сокращаем количество кода</h2>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Аннотация @Builder</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
class Bo
{
    String title
}

@Builder(forClass = Bo, builderStrategy = ExternalStrategy)
class BoBuilder
{
}

static Bo create(@DelegatesTo(BoBuilder) Closure config)
{
    def builder = new BoBuilder()
    builder.with(config)
    return builder.build()
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Проблемы с наследованием</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
trait IHasMake&lt;T>
{
    T make()
    {
        def forClass = this.class.getAnnotation(Builder).forClass()
        def object = (T) forClass.newInstance()
        def properties = object.metaClass.properties.name - 'class'
        properties.each {
            def field = ReflectionUtils.findField(this.class, it)
            if (field)
            {
                ReflectionUtils.makeAccessible(field)
                def value = field.get(this)
                //не заменять на groovy-truth!
                if (value != null)
                {
                    object[it] = value
                }
            }
        }
        return object
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>@DelegatesTo. Дженерики</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
static &lt;T extends Bo, B extends IHasMake&lt;T&gt;&gt; T create(
                        @DelegatesTo.Target B builder,
                        @DelegatesTo Closure config
)
{
    builder.with(config)
    return builder.make()
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>

                <section>
                    <h2>Создание коллекций объектов</h2>
                    <pre style="width:auto;"><code data-trim class="groovy medium">
class CollectionBuilder&lt;T extends Bo, B extends IHasMake&lt;T>>
{
    Class&lt;B> itemBuilderClass
    Collection&lt;T> result = []

    CollectionBuilder(Class&lt;B> itemBuilderClass)
    {
        this.itemBuilderClass = itemBuilderClass
    }

    CollectionBuilder&lt;T, B> item(@DelegatesTo(type = "B", strategy = Closure.DELEGATE_FIRST) Closure config)
    {
        def builder = (B) itemBuilderClass.newInstance()
        result.add(create(builder, config))
        return this
    }

    CollectionBuilder&lt;T, B> item(Bo item)
    {
        result.add(item as T)
        return this
    }

    Collection&lt;T> build()
    {
        return result
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Создание коллекций объектов</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
static &lt;T extends Bo, B extends IHasMake&lt;T>> Collection&lt;T> createCollection(
                        @DelegatesTo.Target CollectionBuilder&lt;T, B> builder,
                        @DelegatesTo Closure config
)
{
    DefaultGroovyMethods.with(builder, config)
    return builder.build()
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Cокращаем количество кода</h2>
                    <pre style="width:auto;"><code data-trim class="groovy medium">
class Bo
{
    String title
}

class Company extends Bo
{
    Collection&lt;Department> _departments = []

    static Company build(@DelegatesTo(CompanyBuilder) Closure config)
    {
        def builder = new CompanyBuilder()
        builder.with(config)
        return create(builder, config)
    }
}

class Department extends Bo
{
    Collection&lt;Employee> _employees = []
}

class Employee extends Bo
{
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Cокращаем количество кода</h2>
                    <pre style="width:auto;"><code data-trim class="groovy medium">
@Builder(forClass = Bo, builderStrategy = ExternalStrategy)
class BoBuilder
{}

@Builder(forClass = Company, builderStrategy = ExternalStrategy)
class CompanyBuilder extends BoBuilder implements IHasMake&lt;Company>
{
    CompanyBuilder departments(@DelegatesTo(DepartmentCollectionBuilder) Closure config)
    {
        def builder = new DepartmentCollectionBuilder(DepartmentBuilder)
        return _departments(createCollection(builder, config))
    }
}

@Builder(forClass = Department, builderStrategy = ExternalStrategy)
class DepartmentBuilder extends BoBuilder implements IHasMake&lt;Department>
{
    DepartmentBuilder employees(@DelegatesTo(EmployeeCollectionBuilder) Closure config)
    {
        def builder = new EmployeeCollectionBuilder(EmployeeBuilder)
        return _employees(createCollection(builder, config))
    }
}

@Builder(forClass = Employee, builderStrategy = ExternalStrategy)
class EmployeeBuilder  extends BoBuilder implements IHasMake&lt;Employee>
{}

@InheritConstructors
class DepartmentCollectionBuilder extends CollectionBuilder&lt;Department, DepartmentBuilder>
{}
@InheritConstructors
class EmployeeCollectionBuilder extends CollectionBuilder&lt;Employee, EmployeeBuilder>
{}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Cокращаем количество кода</h2>
                    <pre style="width:auto;"><code data-trim class="groovy">
Company.build {
    title 'Рога и копыта'
    departments {
        item{
            title 'Управление'
            employees{
                item {
                    title 'Остап Бендер'
                }
            }
        }
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>@DelegatesTo. Стратегии разрешения имен, влияние на автодополнение</h2>
                    <ul>
                        <li>OWNER_FIRST</li>
                        <li>DELEGATE_FIRST</li>
                        <li>OWNER_ONLY</li>
                        <li>DELEGATE_ONLY</li>
                        <li>TO_SELF</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Связи объектов</h2>
                    <h3>По идентификатору</h3>
                    <pre style="width:auto;"><code data-trim class="groovy">
@Singleton
class BoRegistry
{
    Map&lt;String, Bo> bos = [:]

    void register(String id, Bo bo)
    {
        bos[id] = bo
    }

    Bo get(String id)
    {
        return bos[id]
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Связи объектов</h2>
                    <h3>По идентификатору</h3>
                    <pre style="width:auto;"><code data-trim class="groovy medium">
class Bo
{
    String id
    String title
}

static &lt;T extends Bo, B extends IHasMake&lt;T&gt;&gt; T create(
                        @DelegatesTo.Target B builder,
                        @DelegatesTo Closure config
)
{
    builder.with(config)
    T bo = builder.make()

    if (bo.id)
    {
        BoRegistry.instance.register(bo.id, bo)
    }

    return bo
}

static &lt;B extends Bo> B refId(String id)
{
    return (B) BoRegistry.instance.get(id)
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Связи объектов</h2>
                    <h3>По идентификатору</h3>
                    <pre style="width:auto;"><code data-trim class="groovy">
Company.build {
    title 'Рога и копыта'
    departments {
        item {
            title 'Управление'
            employees {
                item {
                    id 'ostap'
                    title 'Остап Бендер'
                }
            }
        }
        item {
            title 'Работа с общественностью'
            employees {
                item refId('ostap')
            }
        }
    }
}
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Связи объектов</h2>
                    <h3>Ссылка на родителя</h3>
                    <pre style="width:auto;"><code data-trim class="groovy">
                    </code></pre>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Циклы и Collection SDK</h2>
                    <ul>
                        <li></li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Заключение</h2>
                    <ul>
                        <li>Много объектов со сложными взаимосвязями - тебе нужен DSL</li>
                        <li>DSL в Groovy можно и без магии</li>
                        <li>DSL легко писать и поддерживать если типизация статическая</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Заключение</h2>
                    <h3>Что нам дал DSL</h3>
                    <ul>
                        <li>DSL достаточно прост, что бы его писали все</li>
                        <li>Параллельные задачи на добавление новых сущностей/настроек больше не блокируют друг друга</li>
                        <li>Автотесты стало проще писать, после того как они стали использовать DSL</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h2>Заключение</h2>
                    <h3>Что нам дала типизация DSL</h3>
                    <ul>
                        <li>Автокомплит в IDE</li>
                        <li>Компиляция не пропускает ошибки</li>
                    </ul>
                    <aside class="notes"></aside>
                </section>
                <section>
                    <h1>Вопросы?</h1>
                    <div class="man-wrapper">
                        <div class="body"></div>
                        <div class="head">
                            <div class="ear" id="left"></div>
                            <div class="ear" id="right"></div>
                            <div class="hair-main">
                                <div class="sideburn" id="left"></div>
                                <div class="sideburn" id="right"></div>
                                <div class="hair-top"></div>
                            </div>
                            <div class="face">
                                <div class="nose"></div>
                                <div class="eye-shadow" id="left">
                                    <div class="eyebrow"></div>
                                    <div class="eye"></div>
                                </div>
                                <div class="eye-shadow" id="right">
                                    <div class="eyebrow"></div>
                                    <div class="eye"></div>
                                </div>
                                <div class="mouth"></div>
                                <div class="chin"></div>
                            </div>
                        </div>
                        <span class="music-note" id="one">Groovy</span>
                        <span class="music-note" id="two">Rocks!</span>
                    </div>
                    <aside class="notes"></aside>
                </section>
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>
            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: false,
                progress: true,
                history: true,
                center: true,
                slideNumber: true,

                transition: "slide", // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    {
                        src: "lib/js/classList.js",
                        condition: function() {
                            return !document.body.classList;
                        }
                    },
                    {
                        src: "plugin/markdown/marked.js",
                        condition: function() {
                            return !!document.querySelector("[data-markdown]");
                        }
                    },
                    {
                        src: "plugin/markdown/markdown.js",
                        condition: function() {
                            return !!document.querySelector("[data-markdown]");
                        }
                    },
                    {
                        src: "plugin/highlight/highlight.js",
                        async: true,
                        condition: function() {
                            return !!document.querySelector("pre code");
                        },
                        callback: function() {
                            hljs.initHighlightingOnLoad();
                        }
                    },
                    { src: "plugin/zoom-js/zoom.js", async: true },
                    { src: "plugin/notes/notes.js", async: true }
                ]
            });
        </script>
    </body>
</html>
